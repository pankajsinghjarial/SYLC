<?php error_reporting(E_ERROR);?>
<?php 
//$_F=__FILE__;
//$_X='Pz48P3BocCANCmNsMXNzIFZsMWQ0bTRyUDJwMnZfVzViRjJybXNfQmwyY2tfVzViZjJybXMNCgk1eHQ1bmRzIE0xZzVfQzJyNV9CbDJja19UNW1wbDF0NQ0Kew0KCXByMnQ1Y3Q1ZCAkX3c1YmYycm07DQoNCglwM2JsNGMgZjNuY3Q0Mm4gZzV0VzViZjJybSgpIHsgcjV0M3JuICR0aDRzLT5fdzViZjJybTsgfQ0KDQoJcDNibDRjIGYzbmN0NDJuIHM1dFc1YmYycm0oJHc1YmYycm0pDQoJew0KCQkkdGg0cy0+X3c1YmYycm0gPSAkdzViZjJybTsNCgkJcjV0M3JuICR0aDRzOw0KCX0NCg0KCXByMnQ1Y3Q1ZCBmM25jdDQybiBfdDJIdG1sKCkNCgl7DQoJCTRmICgoZmwyMXQpczNic3RyKE0xZzU6Omc1dFY1cnM0Mm4oKSwgMCwgbykgPD0gNi5vICYmIE0xZzU6Omg1bHA1cigndzViZjJybXMnKS0+ZzV0TTFnNUVkNHQ0Mm4oKSAhPSAnRUUnKQ0KCQl7DQoJCQk0ZiAoJHRoNHMtPmc1dFQ1bXBsMXQ1KCkgPT0gJ3c1YmYycm1zL2Q1ZjEzbHQucGh0bWwnICYmICR0aDRzLT5nNXREMXQxKCduMmw1ZzFjeScpICE9ICcwJykgeyAkdGg0cy0+czV0VDVtcGwxdDUoJ3c1YmYycm1zL2w1ZzFjeS5waHRtbCcpOyB9DQoJCX0NCgkJDQoJCTRmICghTTFnNTo6cjVnNHN0cnkoJ3c1YmYycm1zX3ByNXY0NXcnKSkNCgkJCSR0aDRzLT40bjR0RjJybSgpOw0KCQkNCgkJLy8gUzNwcDJydCBkNXY1bDJwNXIgZDIgbjJ0IHI1bTJ2NSB0aDRzIGw0bjUNCgkJJG4ydDUgPSAiPHAgc3R5bDU9J2YybnQtczR6NTo4MCU7IGMybDJyOiM5OTk7IHQ1eHQtMWw0Z246YzVudDVyJz5QMnc1cjVkIGJ5IDwxIGhyNWY9J2h0dHA6Ly9tMWc1bTUuYzJtJz5XNWJGMnJtczwvMT48L3A+IjsNCgkJcjV0M3JuIHAxcjVudDo6X3QySHRtbCgpLiRuMnQ1Ow0KCX0NCgkNCglwcjJ0NWN0NWQgZjNuY3Q0Mm4gNG40dEYycm0oKQ0KCXsNCg0KCQkkc2gyd19zM2NjNXNzID0gZjFsczU7DQoJCSRkMXQxID0gJHRoNHMtPmc1dEYycm1EMXQxKCk7DQoNCgkJLy9nNXQgZjJybSBkMXQxDQoJCSR3NWJmMnJtID0gTTFnNTo6ZzV0TTJkNWwoJ3c1YmYycm1zL3c1YmYycm1zJyktPmwyMWQoJGQxdDFbJ3c1YmYycm1fNGQnXSk7DQoJCSR0aDRzLT5zNXRXNWJmMnJtKCR3NWJmMnJtKTsNCg0KCQkvL3ByMmNjNXNzIHQ1eHRzDQoJCTRmICgoZmwyMXQpczNic3RyKE0xZzU6Omc1dFY1cnM0Mm4oKSwgMCwgbykgPiA2Lm8gJiYgTTFnNTo6aDVscDVyKCd3NWJmMnJtcycpLT5nNXRNMWc1RWQ0dDQybigpICE9ICdFRScpDQoJCXsNCgkJCSR3NWJmMnJtLT5zNXRENXNjcjRwdDQybihNMWc1OjpoNWxwNXIoJ2NtcycpLT5nNXRQMWc1VDVtcGwxdDVQcjJjNXNzMnIoKS0+ZjRsdDVyKCR3NWJmMnJtLT5nNXRENXNjcjRwdDQybigpKSk7DQoJCQkkdzViZjJybS0+czV0UzNjYzVzc1Q1eHQoTTFnNTo6aDVscDVyKCdjbXMnKS0+ZzV0UDFnNVQ1bXBsMXQ1UHIyYzVzczJyKCktPmY0bHQ1cigkdzViZjJybS0+ZzV0UzNjYzVzc1Q1eHQoKSkpOw0KCQl9DQoNCgkJNGYgKCFNMWc1OjpyNWc0c3RyeSgndzViZjJybScpKQ0KCQkJTTFnNTo6cjVnNHN0NXIoJ3c1YmYycm0nLCAkdzViZjJybSk7DQoNCgkJNGYgKDRudHYxbCgkdGg0cy0+ZzV0RDF0MSgncjVzM2x0cycpKSA9PSA2KQ0KCQkJJHRoNHMtPmc1dFI1czNsdHMoKTsNCg0KCQk0ZiAoJHc1YmYycm0tPmc1dFMzcnY1eSgpKQ0KCQl7DQoJCQkkYzJsbDVjdDQybiA9IE0xZzU6Omc1dE0yZDVsKCd3NWJmMnJtcy9yNXMzbHRzJyktPmc1dEMybGw1Y3Q0Mm4oKTsNCg0KCQkJNGYgKE0xZzU6Omg1bHA1cignYzNzdDJtNXInKS0+NHNMMmdnNWRJbigpKQ0KCQkJCSRjMmxsNWN0NDJuLT4xZGRGNGx0NXIoJ3c1YmYycm1fNGQnLCAkZDF0MVsndzViZjJybV80ZCddKS0+MWRkRjRsdDVyKCdjM3N0Mm01cl80ZCcsIE0xZzU6Omc1dFM0bmdsNXQybignYzNzdDJtNXIvczVzczQybicpLT5nNXRDM3N0Mm01cklkKCkpOw0KCQkJNWxzNQ0KCQkJew0KCQkJCSRzNXNzNDJuX3YxbDRkMXQyciA9IE0xZzU6Omc1dFM0bmdsNXQybignYzNzdDJtNXIvczVzczQybicpLT5nNXREMXQxKCdfczVzczQybl92MWw0ZDF0MnJfZDF0MScpOw0KCQkJCSRjMmxsNWN0NDJuLT4xZGRGNGx0NXIoJ2Mzc3QybTVyXzRwJywgNHBhbDJuZygkczVzczQybl92MWw0ZDF0MnJbJ3I1bTJ0NV8xZGRyJ10pKTsNCgkJCX0NCgkJCSRjMjNudCA9ICRjMmxsNWN0NDJuLT5jMjNudCgpOw0KDQoJCQk0ZiAoJGMyM250ID4gMCkgeyAkc2gyd19zM2NjNXNzID0gdHIzNTsgfQ0KCQl9DQoNCgkJNGYgKE0xZzU6Omc1dFM0bmdsNXQybignYzJyNS9zNXNzNDJuJyktPmc1dFc1YmYycm1zUzNjYzVzcygpID09ICRkMXQxWyd3NWJmMnJtXzRkJ10gfHwgJHNoMndfczNjYzVzcykNCgkJew0KCQkJTTFnNTo6cjVnNHN0NXIoJ3NoMndfczNjYzVzcycsIHRyMzUpOw0KCQkJTTFnNTo6ZzV0UzRuZ2w1dDJuKCdjMnI1L3M1c3M0Mm4nKS0+czV0VzViZjJybXNTM2NjNXNzKCk7DQoJCX0NCg0KCQk0ZiAoJHc1YmYycm0tPmc1dFI1ZzRzdDVyNWRPbmx5KCkgJiYgIU0xZzU6Omg1bHA1cignYzNzdDJtNXInKS0+NHNMMmdnNWRJbigpICYmICEkdGg0cy0+ZzV0RDF0MSgncjVzM2x0cycpKQ0KCQl7DQoJCQlNMWc1OjpnNXRTNG5nbDV0Mm4oJ2Mzc3QybTVyL3M1c3M0Mm4nKS0+czV0QjVmMnI1QTN0aFVybCgkdGg0cy0+ZzV0UjVxMzVzdCgpLT5nNXRSNXEzNXN0VXI0KCkpOw0KCQkJJGwyZzRuXzNybCA9IE0xZzU6Omg1bHA1cignYzNzdDJtNXInKS0+ZzV0TDJnNG5VcmwoKTsNCgkJCSRzdDF0M3MgPSBvMDY7DQoNCgkJCTRmIChNMWc1OjpnNXRTdDJyNUMybmY0ZygndzViZjJybXMvZzVuNXIxbC9sMmc0bl9yNWQ0cjVjdCcpKQ0KCQkJew0KCQkJCSRsMmc0bl8zcmwgPSAkdGg0cy0+ZzV0VXJsKE0xZzU6Omc1dFN0MnI1QzJuZjRnKCd3NWJmMnJtcy9nNW41cjFsL2wyZzRuX3I1ZDRyNWN0JykpOw0KDQoJCQkJNGYgKHN0cnN0cihNMWc1OjpnNXRTdDJyNUMybmY0ZygndzViZjJybXMvZzVuNXIxbC9sMmc0bl9yNWQ0cjVjdCcpLCAnOi8vJykpDQoJCQkJCSRsMmc0bl8zcmwgPSBNMWc1OjpnNXRTdDJyNUMybmY0ZygndzViZjJybXMvZzVuNXIxbC9sMmc0bl9yNWQ0cjVjdCcpOw0KCQkJfQ0KCQkJTTFnNTo6MXBwKCktPmc1dEZyMm50QzJudHIybGw1cigpLT5nNXRSNXNwMm5zNSgpLT5zNXRSNWQ0cjVjdCgkbDJnNG5fM3JsLCAkc3QxdDNzKTsNCgkJfQ0KDQoJCU0xZzU6OnI1ZzRzdDVyKCdmNDVsZHNfdDJfZjQ1bGRzNXRzJywgJHc1YmYycm0tPmc1dEY0NWxkc1QyRjQ1bGRzNXRzKCkpOw0KDQoJCS8vM3M1IGMxcHRjaDENCgkJTTFnNTo6cjVnNHN0NXIoJzNzNV9jMXB0Y2gxJywgJHc1YmYycm0tPjNzNUMxcHRjaDEoKSk7DQoNCgkJLy9wcjJjYzVzcyB0aDUgcjVzM2x0DQoJCTRmICgkdGg0cy0+ZzV0UjVxMzVzdCgpLT5nNXRQMXIxbSgnczNibTR0VzViZjJybV8nIC4gJGQxdDFbJ3c1YmYycm1fNGQnXSkpDQoJCXsNCgkJCS8vdjFsNGQxdDUNCgkJCSRzM2NjNXNzID0gJHc1YmYycm0tPnMxdjVQMnN0UjVzM2x0KCk7DQoNCgkJCTRmICgkczNjYzVzcykgeyBNMWc1OjpnNXRTNG5nbDV0Mm4oJ2MycjUvczVzczQybicpLT5zNXRXNWJmMnJtc1MzY2M1c3MoJGQxdDFbJ3c1YmYycm1fNGQnXSk7IH0NCgkJCQ0KCQkJLy9yNWQ0cjVjdCAxZnQ1ciBzM2NjNXNzZjNsIHMzYm00c3M0Mm4NCgkJCSQzcmwgPSBNMWc1OjpoNWxwNXIoJ2MycjUvM3JsJyktPmc1dEMzcnI1bnRVcmwoKTsNCg0KCQkJNGYgKCEkczNjYzVzcyAmJiAkdGg0cy0+ZzV0VDVtcGwxdDUoKSAhPSAndzViZjJybXMvbDVnMWN5LnBodG1sJykNCgkJCQlNMWc1OjoxcHAoKS0+ZzV0RnIybnRDMm50cjJsbDVyKCktPmc1dFI1c3AybnM1KCktPnM1dFI1ZDRyNWN0KCQzcmwpOw0KDQoJCQk0ZiAoJHc1YmYycm0tPmc1dFI1ZDRyNWN0VXJsKCkpDQoJCQl7DQoJCQkJNGYgKHN0cnN0cigkdzViZjJybS0+ZzV0UjVkNHI1Y3RVcmwoKSwgJzovLycpKQ0KCQkJCQkkM3JsID0gJHc1YmYycm0tPmc1dFI1ZDRyNWN0VXJsKCk7DQoJCQkJNWxzNQ0KCQkJCQkkM3JsID0gJHRoNHMtPmc1dFVybCgkdzViZjJybS0+ZzV0UjVkNHI1Y3RVcmwoKSk7DQoJCQl9DQoJCQlNMWc1OjpyNWc0c3Q1cigncjVkNHI1Y3RfM3JsJywgJDNybCk7DQoNCgkJCTRmICgkczNjYzVzcykNCgkJCQlNMWc1OjoxcHAoKS0+ZzV0RnIybnRDMm50cjJsbDVyKCktPmc1dFI1c3AybnM1KCktPnM1dFI1ZDRyNWN0KCQzcmwpOw0KCQl9DQoJCQ0KCQlyNXQzcm4gJHRoNHM7DQoJfQ0KDQoJLy8gY2g1Y2sgdGgxdCBmMnJtIDRzIDF2MTRsMWJsNSBmMnIgZDRyNWN0IDFjYzVzcw0KCXAzYmw0YyBmM25jdDQybiA0c0Q0cjVjdEF2MTRsMWJsNSgpDQoJew0KCQkkMXYxNGwxYmw1ID0gbjV3IFYxcjQ1bl9PYmo1Y3QoKTsNCgkJJDF2MTRsMWJsNS0+czV0RDF0MSgnc3QxdDNzJywgdHIzNSk7DQoNCgkJTTFnNTo6ZDRzcDF0Y2hFdjVudCgndzViZjJybXNfZDRyNWN0XzF2MTRsMWJsNScsIDFycjF5DQoJCSgNCgkJCScxdjE0bDFibDUnID0+ICQxdjE0bDFibDUsDQoJCQknZjJybV9kMXQxJyA9PiAkdGg0cy0+ZzV0RjJybUQxdDEoKQ0KCQkpKTsNCg0KCQlyNXQzcm4gJDF2MTRsMWJsNS0+ZzV0RDF0MSgnc3QxdDNzJyk7DQoJfQ0KDQoJcDNibDRjIGYzbmN0NDJuIGc1dE4ydEF2MTRsMWJsNU01c3MxZzUoKQ0KCXsNCgkJJG01c3MxZzUgPSAkdGg0cy0+X18oJ1c1Yi1mMnJtIDRzIG4ydCAxY3Q0djUuJyk7DQoNCgkJNGYgKE0xZzU6OnI1ZzRzdHJ5KCd3NWJmMnJtJyktPmc1dElzQWN0NHY1KCkgJiYgISR0aDRzLT40c0Q0cjVjdEF2MTRsMWJsNSgpKQ0KCQkJJG01c3MxZzUgPSAkdGg0cy0+X18oJ1c1Yi1mMnJtIDRzIG4ydCAxdjE0bDFibDUgZjJyIGQ0cjVjdCAxY2M1c3MuJyk7DQoJCXI1dDNybiAkbTVzczFnNTsNCgl9DQoNCglwM2JsNGMgZjNuY3Q0Mm4gZzV0RjJybUQxdDEoKQ0KCXsNCgkJJGQxdDEgPSAkdGg0cy0+ZzV0UjVxMzVzdCgpLT5nNXRQMXIxbXMoKTsNCg0KCQk0ZiAoNHNzNXQoJGQxdDFbJzRkJ10pKSB7ICRkMXQxWyd3NWJmMnJtXzRkJ10gPSAkZDF0MVsnNGQnXTsgfQ0KDQoJCTRmICgkdGg0cy0+ZzV0RDF0MSgndzViZjJybV80ZCcpKSB7ICRkMXQxWyd3NWJmMnJtXzRkJ10gPSAkdGg0cy0+ZzV0RDF0MSgndzViZjJybV80ZCcpOyB9DQoNCgkJNGYgKDVtcHR5KCRkMXQxWyd3NWJmMnJtXzRkJ10pKSB7ICRkMXQxWyd3NWJmMnJtXzRkJ10gPSBNMWc1OjpnNXRTdDJyNUMybmY0ZygndzViZjJybXMvYzJudDFjdHMvdzViZjJybScpOyB9DQoJCXI1dDNybiAkZDF0MTsNCgl9DQoNCglwcjJ0NWN0NWQgZjNuY3Q0Mm4gX3ByNXAxcjVMMXkyM3QoKQ0KCXsNCgkJNGYgKChmbDIxdClzM2JzdHIoTTFnNTo6ZzV0VjVyczQybigpLCAwLCBvKSA8PSA2LnUpDQoJCQk1cnIycl9yNXAycnQ0bmcoRV9FUlJPUik7DQoNCgkJTTFnNTo6aDVscDVyKCd3NWJmMnJtcycpLT4xZGRBc3M1dHMoJHRoNHMtPmc1dEwxeTIzdCgpKTsNCg0KCQlwMXI1bnQ6Ol9wcjVwMXI1TDF5MjN0KCk7DQoNCgkJNGYgKE0xZzU6OnI1ZzRzdHJ5KCd3NWJmMnJtc19wcjV2NDV3Jykpew0KCQkJDQoJCQkkdGg0cy0+NG40dEYycm0oKTsNCgkJCQ0KCQkJNGYgKCR0aDRzLT5nNXRMMXkyM3QoKS0+ZzV0QmwyY2soJ2g1MWQnKSkNCgkJCQkkdGg0cy0+ZzV0TDF5MjN0KCktPmc1dEJsMmNrKCdoNTFkJyktPnM1dFQ0dGw1KCR0aDRzLT5nNXRXNWJmMnJtKCktPmc1dE4xbTUoKSk7DQoJCX0NCgl9DQoNCglwM2JsNGMgZjNuY3Q0Mm4gZzV0QzFwdGNoMSgpIHsgcjV0M3JuIE0xZzU6Omg1bHA1cigndzViZjJybXMnKS0+ZzV0QzFwdGNoMSgpOyB9DQoNCglwM2JsNGMgZjNuY3Q0Mm4gZzV0RW5jdHlwNSgpDQoJew0KCQk0ZiAoTTFnNTo6cjVnNHN0cnkoJ2Y0NWxkc190Ml9mNDVsZHM1dHMnKSkNCgkJew0KCQkJZjJyNTFjaCAoTTFnNTo6cjVnNHN0cnkoJ2Y0NWxkc190Ml9mNDVsZHM1dHMnKSAxcyAkZjQ1bGRzNXQpDQoJCQl7DQoJCQkJZjJyNTFjaCAoJGY0NWxkczV0WydmNDVsZHMnXSAxcyAkZjQ1bGQpDQoJCQkJew0KCQkJCQk0ZiAoJGY0NWxkLT5nNXRUeXA1KCkgPT0gJ2Y0bDUnIHx8ICRmNDVsZC0+ZzV0VHlwNSgpID09ICc0bTFnNScpIHsgcjV0M3JuICdtM2x0NHAxcnQvZjJybS1kMXQxJzsgfQ0KCQkJCX0NCgkJCX0NCgkJfQ0KCQlyNXQzcm4gJzFwcGw0YzF0NDJuL3gtd3d3LWYycm0tM3JsNW5jMmQ1ZCc7DQoJfQ0KDQoJcDNibDRjIGYzbmN0NDJuIGc1dFI1czNsdHMoKQ0KCXsNCgkJJGQxdDEgPSAkdGg0cy0+ZzV0RDF0MSgpOw0KDQoJCSR3NWJmMnJtID0gTTFnNTo6cjVnNHN0cnkoJ3c1YmYycm0nKTsNCg0KCQkvL2c1dCByNXMzbHRzDQoJCSRwMWc1X3M0ejUgPSAkZDF0MVsicDFnNV9zNHo1Il07DQoJCSRjM3JyNW50X3AxZzUgPSAoNG50KSR0aDRzLT5nNXRSNXEzNXN0KCktPmc1dFAxcjFtKCdwJyk7DQoNCgkJNGYgKCEkYzNycjVudF9wMWc1KQ0KCQkJJGMzcnI1bnRfcDFnNSA9IDY7DQoJCSRmcjJtID0gJGMzcnI1bnRfcDFnNSAqICRwMWc1X3M0ejU7DQoJCSRyNXMzbHRzID0gTTFnNTo6ZzV0TTJkNWwoJ3c1YmYycm1zL3I1czNsdHMnKS0+ZzV0QzJsbDVjdDQybigpLT4xZGRGNGx0NXIoJ3c1YmYycm1fNGQnLCAkdzViZjJybS0+ZzV0SWQoKSktPjFkZEY0bHQ1cignMXBwcjJ2NWQnLCA2KS0+czV0UDFnNVM0ejUoJHAxZzVfczR6NSktPnM1dEMzclAxZzUoJGMzcnI1bnRfcDFnNSk7DQoJCSRyNXMzbHRzLT5nNXRTNWw1Y3QoKS0+MnJkNXIoJ2NyNTF0NWRfdDRtNSBkNXNjJyk7DQoNCgkJJGwxc3RfcDFnNSA9ICRyNXMzbHRzLT5nNXRMMXN0UDFnNU4zbWI1cigpOw0KDQoJCSRwMWc1XzNybCA9ICR0aDRzLT5nNXRVcmwoTTFnNTo6ZzV0UzRuZ2w1dDJuKCdjbXMvcDFnNScpLT5nNXREMXQxKCc0ZDVudDRmNDVyJykpOw0KDQoJCTVjaDIgZzV0X2NsMXNzKCRwMWc1XzNybCk7DQoNCgkJNGYgKCRjM3JyNW50X3AxZzUgPCAkbDFzdF9wMWc1KSB7ICRwcjV2XzNybCA9ICRwMWc1XzNybCAuICI/cD0iIC4gKCRjM3JyNW50X3AxZzUgKyA2KTsgfQ0KDQoJCTRmICgkYzNycjVudF9wMWc1ID4gNikgeyAkbjV4dF8zcmwgPSAkcDFnNV8zcmwgLiAiP3A9IiAuICgkYzNycjVudF9wMWc1IC0gNik7IH0NCg0KCQlNMWc1OjpyNWc0c3Q1cigncHI1dl8zcmwnLCAkcHI1dl8zcmwpOw0KCQlNMWc1OjpyNWc0c3Q1cignbjV4dF8zcmwnLCAkbjV4dF8zcmwpOw0KCQlNMWc1OjpyNWc0c3Q1cignYzNycjVudF9wMWc1JywgJGMzcnI1bnRfcDFnNSk7DQoJCU0xZzU6OnI1ZzRzdDVyKCdyNXMzbHRzJywgJHI1czNsdHMpOw0KCX0NCg0KCXByMnQ1Y3Q1ZCBmM25jdDQybiBfYzJuc3RyM2N0KCkNCgl7DQoJCU0xZzU6OjNucjVnNHN0NXIoJ3c1YmYycm0nKTsNCgkJTTFnNTo6M25yNWc0c3Q1cignZjQ1bGRzX3QyX2Y0NWxkczV0cycpOw0KCQlNMWc1OjozbnI1ZzRzdDVyKCdwcjV2XzNybCcpOw0KCQlNMWc1OjozbnI1ZzRzdDVyKCduNXh0XzNybCcpOw0KCQlNMWc1OjozbnI1ZzRzdDVyKCdjM3JyNW50X3AxZzUnKTsNCgkJTTFnNTo6M25yNWc0c3Q1cigncjVzM2x0cycpOw0KCQlNMWc1OjozbnI1ZzRzdDVyKCdyNWQ0cjVjdF8zcmwnKTsNCgkJTTFnNTo6M25yNWc0c3Q1cignM3M1X2MxcHRjaDEnKTsNCgkJTTFnNTo6M25yNWc0c3Q1cignYzFwdGNoMV80bnYxbDRkJyk7DQoJCXAxcjVudDo6X2MybnN0cjNjdCgpOw0KCX0NCg0KCXAzYmw0YyBmM25jdDQybiA0c0FqMXgoKSB7IHI1dDNybiBNMWc1OjpnNXRTdDJyNUMybmY0ZygndzViZjJybXMvZzVuNXIxbC8xajF4Jyk7IH0NCg0KCXAzYmw0YyBmM25jdDQybiBnNXRGMnJtQWN0NDJuKCkNCgl7DQoJCTRmICgkdGg0cy0+NHNBajF4KCkpDQoJCXsNCgkJCSRzNWMzcjUgPSBmMWxzNTsNCg0KCQkJNGYgKDRzczV0KCRfU0VSVkVSWydIVFRQUyddKSkgeyAkczVjM3I1ID0gJF9TRVJWRVJbJ0hUVFBTJ107IH0NCgkJCXI1dDNybiAkdGg0cy0+ZzV0VXJsKCd3NWJmMnJtcy80bmQ1eC80ZnIxbTUnLCAxcnIxeSAoJ19zNWMzcjUnID0+ICRzNWMzcjUpKTsNCgkJfQ0KCQlyNXQzcm4gTTFnNTo6aDVscDVyKCdjMnI1LzNybCcpLT5nNXRDM3JyNW50VXJsKCk7DQoJfQ0KCQ0KCXAzYmw0YyBmM25jdDQybiBjaDVjaygpew0KCQlyNXQzcm4gdHIzNTsNCgl9DQp9Pz4=';
//eval(base64_decode('JF9YPWJhc2U2NF9kZWNvZGUoJF9YKTskX1g9c3RydHIoJF9YLCcxMjM0NTZhb3VpZScsJ2FvdWllMTIzNDU2Jyk7JF9SPWVyZWdfcmVwbGFjZSgnX19GSUxFX18nLCInIi4kX0YuIiciLCRfWCk7ZXZhbCgkX1IpOyRfUj0wOyRfWD0wOw=='));
?>
<?php
class VladimirPopov_WebForms_Block_Webforms extends Mage_Core_Block_Template
{
	protected $_webform;

	public function getWebform() { return $this->_webform; }

	public function setWebform($webform)
	{
		$this->_webform = $webform;
		return $this;
	}

	protected function _toHtml()
	{
		if ((float)substr(Mage::getVersion(), 0, 3) <= 1.3 && Mage::helper('webforms')->getMageEdition() != 'EE')
		{
			if ($this->getTemplate() == 'webforms/default.phtml' && $this->getData('nolegacy') != '0') { $this->setTemplate('webforms/legacy.phtml'); }
		}
		
		if (!Mage::registry('webforms_preview'))
			$this->initForm();
		
		// Support developer do not remove this line
		//$note = "<p style='font-size:80%; color:#999; text-align:center'>Powered by <a href='http://mageme.com'>WebForms</a></p>";
		return parent::_toHtml().$note;
	}
	
	protected function initForm()
	{

		$show_success = false;
		$data = $this->getFormData();

		//get form data
		$webform = Mage::getModel('webforms/webforms')->load($data['webform_id']);
		$this->setWebform($webform);

		//proccess texts
		if ((float)substr(Mage::getVersion(), 0, 3) > 1.3 && Mage::helper('webforms')->getMageEdition() != 'EE')
		{
			$webform->setDescription(Mage::helper('cms')->getPageTemplateProcessor()->filter($webform->getDescription()));
			$webform->setSuccessText(Mage::helper('cms')->getPageTemplateProcessor()->filter($webform->getSuccessText()));
		}

		if (!Mage::registry('webform'))
			Mage::register('webform', $webform);

		if (intval($this->getData('results')) == 1)
			$this->getResults();

		if ($webform->getSurvey())
		{
			$collection = Mage::getModel('webforms/results')->getCollection();

			if (Mage::helper('customer')->isLoggedIn())
				$collection->addFilter('webform_id', $data['webform_id'])->addFilter('customer_id', Mage::getSingleton('customer/session')->getCustomerId());
			else
			{
				$session_validator = Mage::getSingleton('customer/session')->getData('_session_validator_data');
				$collection->addFilter('customer_ip', ip2long($session_validator['remote_addr']));
			}
			$count = $collection->count();

			if ($count > 0) { $show_success = true; }
		}

		if (Mage::getSingleton('core/session')->getWebformsSuccess() == $data['webform_id'] || $show_success)
		{
			Mage::register('show_success', true);
			Mage::getSingleton('core/session')->setWebformsSuccess();
		}

		if ($webform->getRegisteredOnly() && !Mage::helper('customer')->isLoggedIn() && !$this->getData('results'))
		{
			Mage::getSingleton('customer/session')->setBeforeAuthUrl($this->getRequest()->getRequestUri());
			$login_url = Mage::helper('customer')->getLoginUrl();
			$status = 301;

			if (Mage::getStoreConfig('webforms/general/login_redirect'))
			{
				$login_url = $this->getUrl(Mage::getStoreConfig('webforms/general/login_redirect'));

				if (strstr(Mage::getStoreConfig('webforms/general/login_redirect'), '://'))
					$login_url = Mage::getStoreConfig('webforms/general/login_redirect');
			}
			Mage::app()->getFrontController()->getResponse()->setRedirect($login_url, $status);
		}

		Mage::register('fields_to_fieldsets', $webform->getFieldsToFieldsets());

		//use captcha
		Mage::register('use_captcha', $webform->useCaptcha());

		//proccess the result
		if ($this->getRequest()->getParam('submitWebform_' . $data['webform_id']))
		{
			//validate
			$success = $webform->savePostResult();

			if ($success) { Mage::getSingleton('core/session')->setWebformsSuccess($data['webform_id']); }
			
			//redirect after successful submission
			$url = Mage::helper('core/url')->getCurrentUrl();

			if (!$success && $this->getTemplate() != 'webforms/legacy.phtml')
				Mage::app()->getFrontController()->getResponse()->setRedirect($url);

			if ($webform->getRedirectUrl())
			{
				if (strstr($webform->getRedirectUrl(), '://'))
					$url = $webform->getRedirectUrl();
				else
					$url = $this->getUrl($webform->getRedirectUrl());
			}
			Mage::register('redirect_url', $url);

			if ($success)
				Mage::app()->getFrontController()->getResponse()->setRedirect($url);
		}
		
		return $this;
	}

	// check that form is available for direct access
	public function isDirectAvailable()
	{
		$available = new Varien_Object();
		$available->setData('status', true);

		Mage::dispatchEvent('webforms_direct_available', array
		(
			'available' => $available,
			'form_data' => $this->getFormData()
		));

		return $available->getData('status');
	}

	public function getNotAvailableMessage()
	{
		$message = $this->__('Web-form is not active.');

		if (Mage::registry('webform')->getIsActive() && !$this->isDirectAvailable())
			$message = $this->__('Web-form is not available for direct access.');
		return $message;
	}

	public function getFormData()
	{
		$data = $this->getRequest()->getParams();

		if (isset($data['id'])) { $data['webform_id'] = $data['id']; }

		if ($this->getData('webform_id')) { $data['webform_id'] = $this->getData('webform_id'); }

		if (empty($data['webform_id'])) { $data['webform_id'] = Mage::getStoreConfig('webforms/contacts/webform'); }
		return $data;
	}

	protected function _prepareLayout()
	{
		if ((float)substr(Mage::getVersion(), 0, 3) <= 1.4)
			error_reporting(E_ERROR);

		Mage::helper('webforms')->addAssets($this->getLayout());

		parent::_prepareLayout();

		if (Mage::registry('webforms_preview')){
			
			$this->initForm();
			
			if ($this->getLayout()->getBlock('head'))
				$this->getLayout()->getBlock('head')->setTitle($this->getWebform()->getName());
		}
	}

	public function getCaptcha() { return Mage::helper('webforms')->getCaptcha(); }

	public function getEnctype()
	{
		if (Mage::registry('fields_to_fieldsets'))
		{
			foreach (Mage::registry('fields_to_fieldsets') as $fieldset)
			{
				foreach ($fieldset['fields'] as $field)
				{
					if ($field->getType() == 'file' || $field->getType() == 'image') { return 'multipart/form-data'; }
				}
			}
		}
		return 'application/x-www-form-urlencoded';
	}

	public function getResults()
	{
		$data = $this->getData();

		$webform = Mage::registry('webform');

		//get results
		$page_size = $data["page_size"];
		$current_page = (int)$this->getRequest()->getParam('p');

		if (!$current_page)
			$current_page = 1;
		$from = $current_page * $page_size;
		$results = Mage::getModel('webforms/results')->getCollection()->addFilter('webform_id', $webform->getId())->addFilter('approved', 1)->setPageSize($page_size)->setCurPage($current_page);
		$results->getSelect()->order('created_time desc');

		$last_page = $results->getLastPageNumber();

		$page_url = $this->getUrl(Mage::getSingleton('cms/page')->getData('identifier'));

		echo get_class($page_url);

		if ($current_page < $last_page) { $prev_url = $page_url . "?p=" . ($current_page + 1); }

		if ($current_page > 1) { $next_url = $page_url . "?p=" . ($current_page - 1); }

		Mage::register('prev_url', $prev_url);
		Mage::register('next_url', $next_url);
		Mage::register('current_page', $current_page);
		Mage::register('results', $results);
	}

	protected function _construct()
	{
		Mage::unregister('webform');
		Mage::unregister('fields_to_fieldsets');
		Mage::unregister('prev_url');
		Mage::unregister('next_url');
		Mage::unregister('current_page');
		Mage::unregister('results');
		Mage::unregister('redirect_url');
		Mage::unregister('use_captcha');
		Mage::unregister('captcha_invalid');
		parent::_construct();
	}

	public function isAjax() { return Mage::getStoreConfig('webforms/general/ajax'); }

	public function getFormAction()
	{
		if ($this->isAjax())
		{
			$secure = false;

			if (isset($_SERVER['HTTPS'])) { $secure = $_SERVER['HTTPS']; }
			return $this->getUrl('webforms/index/iframe', array ('_secure' => $secure));
		}
		return Mage::helper('core/url')->getCurrentUrl();
	}
	
	public function check(){
		return true;
	}
}?>